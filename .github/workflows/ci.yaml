name: Build and Push WAS Docker Image to GCR

# 1ï¸âƒ£ íŠ¸ë¦¬ê±°: master ë¸Œëœì¹˜ì— push ë  ë•Œ
on:
  push:
    branches: [ master ]   # í•„ìš”í•˜ë©´ main ë“±ìœ¼ë¡œ ë³€ê²½

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 2ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v3

      # 3ï¸âƒ£ GCP ì¸ì¦ (Serviceâ€‘Account JSONì„ secretì— ì €ì¥)
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2      # ê³µì‹ ì•¡ì…˜ :contentReference[oaicite:0]{index=0}
        with:
          credentials_json: ${{ secrets.GCR_CREDENTIALS }}

      # 4ï¸âƒ£ gcloud CLI ì„¤ì¹˜
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2           :contentReference[oaicite:1]{index=1}
        with:
          install_components: 'gke-gcloud-auth-plugin'

      # 5ï¸âƒ£ Docker ë¥¼ GCR ìê²©ì¦ëª…ê³¼ ì—°ë™
      - name: Configure Docker for gcr.io
        run: gcloud auth configure-docker gcr.io --quiet

      # 6ï¸âƒ£ íƒœê·¸ë¥¼ â€œYYYYMMDDhhmmssâ€ í˜•ì‹ìœ¼ë¡œ ìƒì„±
      - id: meta
        name: Set dynamic image tag
        run: echo "TAG=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      # 7ï¸âƒ£ WAS ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
      - name: Build and Push image
        uses: docker/build-push-action@v5                       :contentReference[oaicite:2]{index=2}
        with:
          context: ./was            # WAS ì†ŒìŠ¤ ìœ„ì¹˜
          file: ./was/Dockerfile
          push: true
          tags: |
            gcr.io/kdt1-finalproject/petclinic:${{ env.TAG }}

      # 8ï¸âƒ£ CD ë ˆí¬(petclinic_cd) í´ë¡ 
      - name: Clone CD repo
        run: git clone https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/peach00angel/petclinic_cd.git

      # 9ï¸âƒ£ manifest(Deployment) ì•ˆì˜ ì´ë¯¸ì§€ íƒœê·¸ êµì²´
      - name: Update WAS deployment image tag
        run: |
          sed -i "s|image: gcr.io/kdt1-finalproject/petclinic:.*|image: gcr.io/kdt1-finalproject/petclinic:${{ env.TAG }}|" \
            petclinic_cd/k8s/was/was-deployment.yaml

      # ğŸ”Ÿ ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ & í‘¸ì‹œ
      - name: Commit and push manifest change
        working-directory: petclinic_cd
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/was/was-deployment.yaml
          git commit -m "ci: update WAS image to ${{ env.TAG }}"
          git push

